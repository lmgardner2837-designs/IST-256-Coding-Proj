<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Billing Submission</title>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <link rel="stylesheet" href="styles/styles.css" />

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<body>
  <header class="bg-danger text-white py-3 mb-4">
    <div class="container d-flex align-items-center justify-content-between">
      <h1 class="h3 mb-0">Billing Submission</h1>
      <div>
        <a href="index.html" class="btn btn-success btn-sm me-2">Home</a>
        <a href="returns.html" class="btn btn-success btn-sm">Handle Returns</a>
      </div>
    </div>
  </header>

  <div id="root"></div>

  <script type="text/babel">
    // Detect sandbox vs local Node server
    const isSandbox =
      window.location.hostname.includes("codingrooms") ||
      window.location.hostname.includes("zybooks");

    const API_BASE = isSandbox ? "" : "http://127.0.0.1:3000";

    function BillingForm() {
      const [form, setForm] = React.useState({
        name: "",
        address: "",
        city: "",
        state: "",
        zip: "",
        card: "",
        cvv: "",
        description: "",
      });

      const [submitted, setSubmitted] = React.useState(false);
      const [error, setError] = React.useState("");
      const [serverError, setServerError] = React.useState("");

      const handleChange = (e) => {
        const { name, value } = e.target;
        setForm((prev) => ({ ...prev, [name]: value }));
      };

      const validate = () => {
        if (!form.name || !form.address || !form.city || !form.state || !form.zip) {
          return "All address fields are required.";
        }

        if (!/^\d{5}$/.test(form.zip)) {
          return "ZIP must be 5 digits.";
        }

        if (!/^\d{16}$/.test(form.card)) {
          return "Card number must be exactly 16 digits.";
        }

        if (!/^\d{3,4}$/.test(form.cvv)) {
          return "CVV must be 3 or 4 digits.";
        }

        return "";
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setServerError("");

        const err = validate();
        if (err) {
          setError(err);
          return;
        }

        setError("");

        // In zyBooks/CodingRooms, don't call the real API
        if (isSandbox) {
          console.log("Sandbox mode: simulating POST /bills", form);
          setSubmitted(true);
          return;
        }

        try {
          const payload = {
            customer_name: form.name,
            email: "test@example.com", // static for now
            address: form.address,
            city: form.city,
            state: form.state,
            zip: form.zip,
            card: form.card,
            cvv: form.cvv,
            description: form.description,
            status: "pending",
          };

          const res = await fetch(`${API_BASE}/bills`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error("Server returned " + res.status);
          }

          const data = await res.json();
          console.log("Created bill:", data);
          setSubmitted(true);
        } catch (err) {
          console.error("Billing submit error:", err);
          setServerError(
            "Could not submit. Is the Node server running on port 3000?"
          );
        }
      };

      if (submitted) {
        return (
          <div className="container mt-4">
            <div className="panel-white">
              <div className="alert alert-success mb-0">
                Billing submitted successfully!
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="container mt-4">
          <div className="panel-white">
            <h2 className="mb-3 text-center">Enter Billing Information</h2>

            {error && <div className="alert alert-warning">{error}</div>}
            {serverError && (
              <div className="alert alert-danger">{serverError}</div>
            )}

            <form onSubmit={handleSubmit} className="row g-3">
              <div className="col-md-6">
                <label className="form-label">Name</label>
                <input
                  type="text"
                  className="form-control"
                  name="name"
                  value={form.name}
                  onChange={handleChange}
                />
              </div>
              <div className="col-md-6">
                <label className="form-label">Address</label>
                <input
                  type="text"
                  className="form-control"
                  name="address"
                  value={form.address}
                  onChange={handleChange}
                />
              </div>

              <div className="col-md-4">
                <label className="form-label">City</label>
                <input
                  type="text"
                  className="form-control"
                  name="city"
                  value={form.city}
                  onChange={handleChange}
                />
              </div>
              <div className="col-md-4">
                <label className="form-label">State</label>
                <input
                  type="text"
                  className="form-control"
                  name="state"
                  value={form.state}
                  onChange={handleChange}
                />
              </div>
              <div className="col-md-4">
                <label className="form-label">ZIP</label>
                <input
                  type="text"
                  className="form-control"
                  name="zip"
                  value={form.zip}
                  onChange={handleChange}
                />
              </div>

              <div className="col-md-8">
                <label className="form-label">Card Number</label>
                <input
                  type="text"
                  className="form-control"
                  name="card"
                  value={form.card}
                  onChange={handleChange}
                />
              </div>
              <div className="col-md-4">
                <label className="form-label">CVV</label>
                <input
                  type="text"
                  className="form-control"
                  name="cvv"
                  value={form.cvv}
                  onChange={handleChange}
                />
              </div>

              <div className="col-12">
                <label className="form-label">Description</label>
                <textarea
                  className="form-control"
                  rows="3"
                  name="description"
                  value={form.description}
                  onChange={handleChange}
                ></textarea>
              </div>

              <div className="col-12">
                <button type="submit" className="btn btn-primary">
                  Submit Billing
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<BillingForm />);
  </script>
</body>
</html>
